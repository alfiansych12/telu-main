generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(uuid()) @db.Uuid
  email                String               @unique @db.VarChar(255)
  name                 String               @db.VarChar(255)
  role                 UserRole?            @default(participant)
  unit_id              String?              @db.Uuid
  status               EntityStatus?        @default(active)
  internship_start     DateTime?            @db.Date
  internship_end       DateTime?            @db.Date
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?            @default(now()) @db.Timestamptz(6)
  password             String?
  supervisor_id        String?              @db.Uuid
  institution_name     String?              @db.VarChar(255)
  institution_type     String?              @db.VarChar(50)
  personal_email       String?              @db.VarChar(255)
  phone                String?              @db.VarChar(20)
  photo                String?
  deleted_at           DateTime?            @db.Timestamptz(6)
  deleted_by           String?              @db.Uuid
  evaluations          Assessment[]         @relation("EvaluatorUser")
  assessments          Assessment[]         @relation("VictimUser")
  attendances          Attendance[]
  audit_logs           AuditLog[]
  leave_requests       LeaveRequest[]
  monitoring_locations MonitoringLocation[]
  managed_units        Unit[]               @relation("UnitManager")
  notifications        UserNotification[]
  supervisor           User?                @relation("UserToUser", fields: [supervisor_id], references: [id], onUpdate: NoAction)
  subordinates         User[]               @relation("UserToUser")
  unit                 Unit?                @relation(fields: [unit_id], references: [id], onUpdate: NoAction)

  @@index([supervisor_id], map: "idx_users_supervisor_id")
  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@index([unit_id], map: "idx_users_unit_id")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String?  @db.Uuid
  action     String   @db.VarChar(255)
  entity     String   @db.VarChar(255)
  entity_id  String?  @db.VarChar(255)
  details    Json?
  ip_address String?  @db.VarChar(45)
  user_agent String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  user       User?    @relation(fields: [user_id], references: [id])

  @@index([user_id], map: "idx_audit_logs_user_id")
  @@index([action], map: "idx_audit_logs_action")
  @@index([entity], map: "idx_audit_logs_entity")
  @@map("audit_logs")
}

model Unit {
  id           String        @id @default(uuid()) @db.Uuid
  name         String        @db.VarChar(255)
  department   String        @db.VarChar(255)
  manager_id   String?       @db.Uuid
  manager_name String?       @db.VarChar(255)
  status       EntityStatus? @default(active)
  created_at   DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at   DateTime?     @default(now()) @db.Timestamptz(6)
  capacity     Int?          @default(10)
  description  String?
  deleted_at   DateTime?     @db.Timestamptz(6)
  deleted_by   String?       @db.Uuid
  manager      User?         @relation("UnitManager", fields: [manager_id], references: [id], onUpdate: NoAction)
  users        User[]

  @@index([status], map: "idx_units_status")
  @@index([department], map: "idx_units_department")
  @@map("units")
}

model Attendance {
  id                   String            @id @default(uuid()) @db.Uuid
  user_id              String            @db.Uuid
  date                 DateTime          @db.Date
  check_in_time        DateTime?         @db.Time(6)
  check_out_time       DateTime?         @db.Time(6)
  activity_description String?
  status               AttendanceStatus? @default(present)
  created_at           DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?         @default(now()) @db.Timestamptz(6)
  user                 User              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, date], name: "attendances_user_id_date_key")
  @@index([user_id], map: "idx_attendances_user_id")
  @@index([date], map: "idx_attendances_date")
  @@index([status], map: "idx_attendances_status")
  @@map("attendances")
}

model MonitoringLocation {
  id            String         @id @default(uuid()) @db.Uuid
  user_id       String         @db.Uuid
  location_name String         @db.VarChar(255)
  latitude      Decimal?       @db.Decimal(10, 8)
  longitude     Decimal?       @db.Decimal(11, 8)
  request_date  DateTime       @db.Date
  reason        String?
  status        RequestStatus? @default(pending)
  notes         String?
  created_at    DateTime?      @default(now()) @db.Timestamptz(6)
  user          User           @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_monitoring_user_id")
  @@index([status], map: "idx_monitoring_status")
  @@index([request_date], map: "idx_monitoring_request_date")
  @@map("monitoring_locations")
}

model LeaveRequest {
  id         String        @id @default(uuid()) @db.Uuid
  user_id    String        @db.Uuid
  type       LeaveType     @default(permit)
  start_date DateTime      @db.Date
  end_date   DateTime      @db.Date
  reason     String?
  evidence   String?
  status     RequestStatus @default(pending)
  notes      String?
  created_at DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at DateTime?     @default(now()) @db.Timestamptz(6)
  user       User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_leave_request_user_id")
  @@index([status], map: "idx_leave_request_status")
  @@map("leave_requests")
}

model SystemSetting {
  id          String    @id @default(uuid()) @db.Uuid
  key         String    @unique @db.VarChar(255)
  value       Json
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@map("system_settings")
}

model Assessment {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  evaluator_id String    @db.Uuid
  soft_skill   Int       @default(0)
  hard_skill   Int       @default(0)
  attitude     Int       @default(0)
  remarks      String?
  period       String?
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)
  evaluator    User      @relation("EvaluatorUser", fields: [evaluator_id], references: [id], onDelete: Cascade)
  user         User      @relation("VictimUser", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_assessments_user_id")
  @@index([evaluator_id], map: "idx_assessments_evaluator_id")
  @@map("assessments")
}

model UserNotification {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  title      String   @db.VarChar(255)
  message    String
  type       String   @db.VarChar(50)
  is_read    Boolean  @default(false)
  link       String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
  @@map("user_notifications")
}

enum AttendanceStatus {
  present
  absent
  late
  permit
  sick
}

enum LeaveType {
  sick
  permit
}

enum UserRole {
  admin
  supervisor
  participant
}

enum EntityStatus {
  active
  inactive
}

enum RequestStatus {
  pending
  approved
  rejected
}
